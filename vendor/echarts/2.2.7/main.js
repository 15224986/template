define(function(e){function t(e,t,n,r){this._init(e,t,n,r)}return t.prototype._echartsContainer=null,t.prototype._map=null,t.prototype._ec=null,t.prototype._geoCoord=[],t.prototype._mapOffset=[0,0],t.prototype._init=function(e,t,n,r){function o(){}function a(e){return function(){var t=p._echartsContainer.parentNode.parentNode.parentNode;p._mapOffset=[-parseInt(t.style.left)||0,-parseInt(t.style.top)||0],p._echartsContainer.style.left=p._mapOffset[0]+"px",p._echartsContainer.style.top=p._mapOffset[1]+"px",d(e)}}function i(e){return function(){var t=e?"disableDragging":"enableDragging";p._map[t]()}}function d(e){var t=p["on"+e];t?t():p.refresh()}var p=this;p._map=e.constructor==t.Map?e:new t.Map(e,r),(o.prototype=new t.Overlay).initialize=function(e){var t=e.getSize(),n=p._echartsContainer=document.createElement("div");return n.style.position="absolute",n.style.height=t.height+"px",n.style.width=t.width+"px",n.style.top=0,n.style.left=0,e.getPanes().labelPane.appendChild(n),n},o.prototype.draw=function(){};var f=new o;p.getEchartsContainer=function(){return p._echartsContainer},p.getMap=function(){return p._map},p.onmoving=null,p.onmoveend=null,p.onzoom=null,p.geoCoord2Pixel=function(e){if(e){var n=new t.Point(e[0],e[1]),r=p._map.pointToOverlayPixel(n);return[r.x,r.y]}return[0,0]},p.pixel2GeoCoord=function(e){var t=p._map.overlayPixelToPoint({x:e[0],y:e[1]});return[t.lng,t.lat]},p.initECharts=function(){return p._ec=n.init.apply(p,arguments),p._bindEvent(),p._addMarkWrap(),p._ec},p._addMarkWrap=function(){p._ec._addMarkOri=p._ec._addMark,p._ec._addMark=function(e,t,n){if("markPoint"==n){var r;if((r=t.data)&&r.length)for(var o=0,a=r.length;o<a;o++)p._AddPos(r[o])}else if((r=t.data)&&r.length)for(var o=0,a=r.length;o<a;o++)p._AddPos(r[o][0]),p._AddPos(r[o][1]);p._ec._addMarkOri(e,t,n)}},p.getECharts=function(){return p._ec},p.getMapOffset=function(){return p._mapOffset},p.setOption=function(e,t){for(var n=e.series||{},r=0;i=n[r++];){var o=i.geoCoord;if(o)for(var a in o)p._geoCoord[a]=o[a]}for(var i,r=0;i=n[r++];){var d=i.markPoint||{},f=i.markLine||{},_=d.data;if(_&&_.length)for(var a=0,l=_.length;a<l;a++)p._AddPos(_[a]);if((_=f.data)&&_.length)for(var a=0,l=_.length;a<l;a++)p._AddPos(_[a][0]),p._AddPos(_[a][1])}p._ec.setOption(e,t)},p._AddPos=function(e){var t=this._geoCoord[e.name],n=this.geoCoord2Pixel(t);e.x=n[0]-p._mapOffset[0],e.y=n[1]-p._mapOffset[1]},p._bindEvent=function(){p._map.addEventListener("zoomend",function(){d("zoom")}),p._map.addEventListener("moving",a("moving")),p._map.addEventListener("moveend",a("moveend")),p._ec.getZrender().on("dragstart",i(!0)),p._ec.getZrender().on("dragend",i(!1))},p.refresh=function(){if(p._ec){var e=p._ec.getOption(),t=p._ec.component||{},n=t.legend,r=t.dataRange;n&&(e.legend.selected=n.getSelectedMap()),r&&(e.dataRange.range=r._range),p._ec.clear(),p.setOption(e)}},p._map.addOverlay(f)},t});